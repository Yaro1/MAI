<html><head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=koi8-r"><title>Руководство по NASM</title>

<META NAME="GENERATOR" CONTENT="Super-Puper-Mega-Proga">
</head>
<body bgcolor="#DDE1C2"><b><a href="http://www.opennet.ru/docs/">Архив документации OpenNet.ru</a> / 
Раздел "<a href="http://www.opennet.ru/docs/124.shtml">Программирование, языки</a>" /
<a href="index.html">Индекс</a>
</b>
<hr noshade size=1>

<h1 align=center>Расширенный ассемблер: NASM</h1>

<p align=center>Приложение | <a href="nasm_ru9.html">Предыдущая 
  глава</a> | <a href="contents.html">Содержание</a> | Указатель
</p>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr> 
    <td width="69%"> 
      <h2><a name="chapter-10">Глава 10: Разрешение проблем</a></h2>
    </td>
    <td width="31%"> 
      <div align="right"><font size="-1" color="#666666">Перевод: <a href="http://asmdev.narod.ru/asmos.html">
AsmOS group</a>, &copy; 2001</font></div>
    </td>
  </tr>
</table>
<p>Эта глава описывает некоторые из проблем, с которыми, насколько известно, обычно 
  сталкиваются пользователи NASM, и методы их преодоления. Также здесь описан 
  способ сообщения об ошибках NASM команде его разработчиков, в случае, если вы 
  столкнетесь с трудностями, не описанными в данной главе. 
<h3><a name="section-10.1">10.1 Общие проблемы</a></h3>
<h4><a name="section-10.1.1">10.1.1 Генерация NASM неэффективного кода</a></h4>
<p>Я получаю много сообщений об ошибках, в которых говорится, что NASM генерирует 
  неэффективный или неверный (при использовании инструкций типа <font color="#000099">ADD 
  ESP, 8</font>) код. Это преднамеренная особенность дизайна, связанная с предсказуемостью 
  вывода: видя инструкцию типа "<font color="#000099">ADD ESP, 8</font>", NASM 
  генерирует команду, оставляющую место для 32-битного смещения. Если вы хотите 
  использовать оптимизированную по размеру инструкцию, то должны использовать 
  "<font color="#000099">ADD ESP, BYTE 8</font>". Это не ошибка, это просто моя 
  точка зрения. 
<h4><a name="section-10.1.2">10.1.2 Мои "JUMPы" вне диапазона</a></h4>
      <p>Также люди жалуются, что когда они используют переходы по условию (которые 
        являются типа <font color="#000099">SHORT</font> по умолчанию), которые 
        пытаются перейти слишком далеко, то NASM сообщает "<font color="#000099">SHORT 
        JUMP OUT OF RANGE</font>", вместо использования более длинного перехода. 
      <p>Это снова частичная проблема предсказуемости, имеющая также практическую 
        причину. NASM не имеет возможности узнать, для какого типа процессора 
        будет использоваться этот код, так что он не может решить сам использовать 
        переход типа NEAR, потому что не знает, что программа предназначается 
        для процессора 386 и выше. Аналогично, NASM может заменить инструкцию 
        <font color="#000099">JNE</font> типа <font color="#000099">SHORT</font>, 
        которая пыталась бы выйти за диапазон, на более короткую команду <font color="#000099">JE</font>, 
        использующей <font color="#000099">JUMP NEAR</font> &#151; это разумное 
        решение для процессоров ниже 386, но не эффективное для процессоров, имеющих 
        хорошее предсказание перехода и в состоянии осуществить <font color="#000099">JMP 
        NEAR</font>. Так что, повторяю &#151; это пользователю, а не ассемблеру 
        решать, какие команды должны быть сгенерированы. 
      <p>Люди, пишущие загрузочный сектор в двоичном формате, часто жалуются, 
        что <font color="#000099">ORG</font> работает не так, как им хотелось 
        бы: чтобы поместить сигнатуру <font color="#000099">0xAA55</font> в конец 
        512-ти байтного загрузочного сектора, те, кто привык к MASM, имеют тенденцию 
        делать следующее 
     <p> 
      <pre><font color="#666666">          ORG 0 
          ; код загрузчика 
          ORG 510 
          DW 0xAA55</font>
</pre>
     <p>В NASM <font color="#000099">ORG</font> не предназначена для этого. Правильный 
        способ заключается в использовании директивы <font color="#000099">TIMES</font>: 
     <pre><font color="#666666">          ORG 0 
          ; код загрузчика 
          TIMES 510-($-$$) DB 0 
          DW 0xAA55</font>
</pre>
     <p>Директива <font color="#000099">TIMES</font> вставит необходимое количество 
        нулей в код вплоть до 510-го байта. Еще одно преимущество этого метода 
        в том, что если вы выйдете за допустимые размеры загрузочного сектора, 
        то NASM перехватит эту ошибку еще во время ассемблирования и сообщит об 
        этом, так что вам не придется "доводить" программу дизассемблированием 
        и поиском ошибки. 
<h4><a name="section-10.1.4">10.1.4 <font color="#000099">TIMES</font> не работает</a></h4>
      <p>Другая обычная проблема с вышеупомянутым кодом бывает у тех, кто пишет 
      <p> 
      <pre><font color="#666666">          TIMES 510-$ DB 0</font></pre>
      <p>полагая, что <font color="#000099">$</font> - это просто число (как и 
        510), и что разница тоже будет числом и эту разницу можно спокойно преподнести 
        <font color="#000099">TIMES</font>. 
     <p>NASM &#151; <i>модульный</i> ассемблер: различные составляющие части 
        разработаны так, чтобы их было легко повторно использовать по отдельности, 
        так что они не обмениваются информацией без необходимости. В последствии, 
        даже зная, что выходной двоичный формат имеет <font color="#000099">ORG 
        0</font> (и секция <font color="#000099">.text</font> будет начинаться 
        с <font color="#000099">0</font>), эта информация не поступит назад к 
        оценщику выражений. Так что, с точки зрения оценщика, <font color="#000099">$</font> 
        &#151; не просто число, а адрес, включающий смещение от базы (основы) 
        сегмента. Поэтому разница между <font color="#000099">$</font> и <font color="#000099">510</font> 
        тоже будет включать значение смещения от базы сегмента (<font color="#000099">0х1234:0х5678</font> 
        вместо <font color="#000099">0х5678</font>, например). Значение, включающее 
        смещение, нельзя передавать в качестве параметра директиве <font color="#000099">TIMES</font>. 
     <p>Решение можно увидеть в предыдущем примере: 
      <p> 
      <pre><font color="#666666">          TIMES 510-($-$$) DB 0</font></pre>
      <p>Здесь <font color="#000099">$</font> и <font color="#000099">$$</font> 
        содержат смещения относительно одного и того же сегмента, так что их разница 
        &#151; простое число. Это решит проблему и будет сгенерирован правильный 
        код. 

<h3><a name="section-10.2">10.2 Дефекты (ошибки)</a></h3>
      <p>Мы пока еще не выпускали ни одной версии NASM с дефектами, о которых 
        мы <i>знаем</i>. Хотя это и не исключает наличия множества таких дефектов, 
        о которых мы просто не знаем. О любом, найденном вами, вы должны сообщить 
        по адресу <a href="mailto:hpa@zytor.com">hpa@zytor.com</a>. 
      <p>Прежде чем сообщать о дефекте, пожалуйста, внимательно прочитайте <a href="nasm_ru2.html#section-2.2">параграф 
        2.2</a>, там перечислены преднамеренно созданные особенности, которые 
        можно принять за ошибки в NASM. (Если же что-то не описано там и кажется 
        вам ошибкой, то будем рады получить ваши подробные комментарии, а не просто 
        письмо типа "Это - ошибка"). После этого прочитайте <a href="#section-10.1">параграф 
        10.1</a>, и не сообщайте об ошибке, если она уже там описана. 
      <p>Если вы создаете отчет об ошибке, <i>пожалуйста</i>, сообщите нам всю 
        нижеследующую информацию: 
      <ul>
        <li>Под какой ОС вы запускаете NASM: DOS, Linux, NetBSD, Win16, Win32, 
          VMS (я бы удивился :) ), какая-то еще. 
        <li>Если вы запустили NASM из-под DOS или Win32, то сообщите, какой из 
          компиляторов вы используете &#151; стандартный из дистрибутива или откомпилированный 
          вами. Если это "ваш" компилятор, то попробуйте воссоздать ошибку на 
          "родном" из дистрибутива. Эта информация поможет нам быстрее исправить 
          ошибку. 
        <li>Какую версию NASM вы используете и подробности того, как вы вызвали 
          сбой. Сообщите нам полностью командную строку и переменные окружения 
          NASM (если есть). 
        <li>Какие версии других программ вы используете и как вы их вызываете. 
          Если сбой возникает во время линковки, то сообщите версию и название 
          компоновщика, его командную строку. Если возникает проблема при линковке 
          с объектным файлом, созданным другим компилятором, то сообщите нам, 
          что за компилятор, версию и командную строку или опции, использованные 
          вами. (Если вы использовали IDE, то попробуйте воспользоваться версией 
          компилятора для командной строки). 
        <li>Если это возможно, то вышлите нам исходный файл, вызывающий ошибку. 
          Если же могут возникнуть проблемы связанные с авторским правом (например, 
          вы можете воспроизвести ошибку в отдельном файле проекта), тогда имейте 
          в виду следующее: во-первых, весь исходный код, высланный к нам, будет 
          использоваться <i>только</i> для обнаружения и исправления ошибки NASM, 
          и мы удалим все копии у себя; во-вторых, мы предпочли бы <i>не</i> получать 
          большие куски кода. Чем меньше файл &#151; тем лучше. Гораздо легче 
          работать с файлом из трех строчек кода, <i>показывающего</i> ошибку, 
          чем с полнофункциональной программой из десятков тысяч строк кода. (Конечно 
          же, некоторые ошибки могут возникнуть в <i>только</i> большем файле, 
          мы это понимаем). 
        <li>Точное описание смысла проблемы. Просто "Это не работает" <i>не</i> 
          сможет помочь! Пожалуйста, объясните точно - что вы хотели получить 
          и не получили (или наоборот - получили то, чего не должно было быть). 
          Например: "NASM показывает ошибку в 3-ей строке, а она в 5-ой"; "NASM 
          сообщает об ошибке, а я <i>уверен</i>, что ее нет"; "NASM не сообщил 
          об ошибке, которая точно есть"; "Объектный файл, созданный из этого 
          кода, не подходит моему компоновщику"; "Девятый байт выходного файла 
          равен 66, а я думаю, что должно быть 77". 
        <li>Если вы уверены, что выходной файл не верен, то пошлите его нам. Это 
          поможет нам определить, создаст ли наша собственная копия NASM такой 
          же файл или проблема в переносимости между нашей платформой разработки 
          и вашей. Мы можем принимать двоичные файлы в виде <font color="#000099">MIME</font>-прикреплений, 
          формате <font color="#000099">uuencode</font> и даже <font color="#000099">BinHex</font>. 
          Так же мы можем предоставить вам ftp-сайт, на который вы сможете загрузить 
          данный файл, но получить его по почте для нас было бы удобней. 
        <li>Любую другую информацию или файлы, которые могут быть полезны. Если, 
          например, проблема в том, что NASM не может сгенерировать объектный 
          файл, в то время, как TASM создает его без проблем, то пошлите нам <i>оба</i> 
          объектных файла, чтобы мы могли увидеть, что делает TASM в отличие от 
          NASM. 
      </ul>
<ul>
  <div align="center">Приложение | <a href="nasm_ru9.html">Предыдущая 
    глава</a> | <a href="contents.html">Содержание</a> | Указатель
  </div>
</ul>
<hr noshade size=1>
<b><a href="http://www.opennet.ru/docs/">Архив документации на OpenNet.ru</a>
</body></html>
